# =============================================================================
# Neo Service Layer - Production Manifest
# =============================================================================
# This manifest defines the confidential microservices mesh configuration
# for the Neo Service Layer based on MarbleRun + Supabase architecture.

# =============================================================================
# Packages - Enclave Software Definitions
# =============================================================================
Packages:
  # Oracle service package
  oracle-pkg:
    SignerID: "1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
    ProductID: 1
    SecurityVersion: 1
    AcceptedTCBStatuses:
      - UpToDate
      - SWHardeningNeeded

  # VRF (Verifiable Random Function) service package
  vrf-pkg:
    SignerID: "1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
    ProductID: 2
    SecurityVersion: 1
    AcceptedTCBStatuses:
      - UpToDate
      - SWHardeningNeeded

  # Secrets management service package
  secrets-pkg:
    SignerID: "1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
    ProductID: 3
    SecurityVersion: 1
    AcceptedTCBStatuses:
      - UpToDate
      - SWHardeningNeeded

  # Gas bank service package
  gasbank-pkg:
    SignerID: "1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
    ProductID: 4
    SecurityVersion: 1
    AcceptedTCBStatuses:
      - UpToDate
      - SWHardeningNeeded

  # Data feeds service package
  datafeeds-pkg:
    SignerID: "1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
    ProductID: 5
    SecurityVersion: 1
    AcceptedTCBStatuses:
      - UpToDate
      - SWHardeningNeeded

  # Automation service package
  automation-pkg:
    SignerID: "1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
    ProductID: 6
    SecurityVersion: 1
    AcceptedTCBStatuses:
      - UpToDate
      - SWHardeningNeeded

# =============================================================================
# Marbles - Service Instance Definitions
# =============================================================================
Marbles:
  oracle:
    Package: oracle-pkg
    MaxActivations: 10
    Parameters:
      Env:
        MARBLE_TYPE: oracle
        SUPABASE_URL: "{{ .Env.SUPABASE_URL }}"
        LOG_LEVEL: info
      Files:
        /app/config.json: |
          {
            "service": "oracle",
            "max_concurrent_requests": 100,
            "request_timeout_seconds": 30
          }
    TLS:
      Incoming:
        - Port: "8443"
          Cert: oracle-cert
          DisableClientAuth: true
      Outgoing:
        - Port: "443"
          Cert: oracle-cert
          AllowedMarbles:
            - coordinator

  vrf:
    Package: vrf-pkg
    MaxActivations: 5
    Parameters:
      Env:
        MARBLE_TYPE: vrf
        SUPABASE_URL: "{{ .Env.SUPABASE_URL }}"
        LOG_LEVEL: info
      Files:
        /app/config.json: |
          {
            "service": "vrf",
            "key_derivation": "hkdf-sha256"
          }
    TLS:
      Incoming:
        - Port: "8443"
          Cert: vrf-cert
          DisableClientAuth: true
      Outgoing:
        - Port: "443"
          Cert: vrf-cert
          AllowedMarbles:
            - coordinator

  secrets:
    Package: secrets-pkg
    MaxActivations: 3
    Parameters:
      Env:
        MARBLE_TYPE: secrets
        SUPABASE_URL: "{{ .Env.SUPABASE_URL }}"
        LOG_LEVEL: info
      Files:
        /app/config.json: |
          {
            "service": "secrets",
            "encryption": "aes-256-gcm",
            "max_secret_size_bytes": 65536
          }
    TLS:
      Incoming:
        - Port: "8443"
          Cert: secrets-cert
          AllowedMarbles:
            - oracle
            - vrf
            - automation
      Outgoing:
        - Port: "443"
          Cert: secrets-cert
          AllowedMarbles:
            - coordinator

  gasbank:
    Package: gasbank-pkg
    MaxActivations: 3
    Parameters:
      Env:
        MARBLE_TYPE: gasbank
        SUPABASE_URL: "{{ .Env.SUPABASE_URL }}"
        LOG_LEVEL: info
      Files:
        /app/config.json: |
          {
            "service": "gasbank",
            "min_balance_wei": "1000000000000000",
            "fee_percentage": 0.1
          }
    TLS:
      Incoming:
        - Port: "8443"
          Cert: gasbank-cert
          DisableClientAuth: true
      Outgoing:
        - Port: "443"
          Cert: gasbank-cert
          AllowedMarbles:
            - coordinator

  datafeeds:
    Package: datafeeds-pkg
    MaxActivations: 5
    Parameters:
      Env:
        MARBLE_TYPE: datafeeds
        SUPABASE_URL: "{{ .Env.SUPABASE_URL }}"
        LOG_LEVEL: info
      Files:
        /app/config.json: |
          {
            "service": "datafeeds",
            "default_update_interval_seconds": 60,
            "max_feeds_per_user": 100
          }
    TLS:
      Incoming:
        - Port: "8443"
          Cert: datafeeds-cert
          DisableClientAuth: true
      Outgoing:
        - Port: "443"
          Cert: datafeeds-cert
          AllowedMarbles:
            - coordinator
            - oracle

  automation:
    Package: automation-pkg
    MaxActivations: 5
    Parameters:
      Env:
        MARBLE_TYPE: automation
        SUPABASE_URL: "{{ .Env.SUPABASE_URL }}"
        LOG_LEVEL: info
      Files:
        /app/config.json: |
          {
            "service": "automation",
            "max_execution_time_seconds": 300,
            "max_tasks_per_user": 50
          }
    TLS:
      Incoming:
        - Port: "8443"
          Cert: automation-cert
          DisableClientAuth: true
      Outgoing:
        - Port: "443"
          Cert: automation-cert
          AllowedMarbles:
            - coordinator
            - oracle
            - vrf
            - secrets

# =============================================================================
# Secrets - Cryptographic Material
# =============================================================================
Secrets:
  # Supabase service key (user-defined, set via API)
  supabase_service_key:
    Type: plain
    UserDefined: true

  # Master encryption key for user secrets
  master_encryption_key:
    Type: symmetric-key
    Size: 256
    Shared: true

  # VRF signing key
  vrf_signing_key:
    Type: cert-ecdsa
    Cert:
      Subject:
        CommonName: "Neo VRF Signer"
        Organization:
          - "Neo Service Layer"
      ValidityDays: 365

  # Service certificates
  oracle-cert:
    Type: cert-ecdsa
    Cert:
      Subject:
        CommonName: "oracle.neo-service-layer.local"
      DNSNames:
        - oracle
        - oracle.neo-service-layer.local
        - localhost
      ValidityDays: 90

  vrf-cert:
    Type: cert-ecdsa
    Cert:
      Subject:
        CommonName: "vrf.neo-service-layer.local"
      DNSNames:
        - vrf
        - vrf.neo-service-layer.local
        - localhost
      ValidityDays: 90

  secrets-cert:
    Type: cert-ecdsa
    Cert:
      Subject:
        CommonName: "secrets.neo-service-layer.local"
      DNSNames:
        - secrets
        - secrets.neo-service-layer.local
        - localhost
      ValidityDays: 90

  gasbank-cert:
    Type: cert-ecdsa
    Cert:
      Subject:
        CommonName: "gasbank.neo-service-layer.local"
      DNSNames:
        - gasbank
        - gasbank.neo-service-layer.local
        - localhost
      ValidityDays: 90

  datafeeds-cert:
    Type: cert-ecdsa
    Cert:
      Subject:
        CommonName: "datafeeds.neo-service-layer.local"
      DNSNames:
        - datafeeds
        - datafeeds.neo-service-layer.local
        - localhost
      ValidityDays: 90

  automation-cert:
    Type: cert-ecdsa
    Cert:
      Subject:
        CommonName: "automation.neo-service-layer.local"
      DNSNames:
        - automation
        - automation.neo-service-layer.local
        - localhost
      ValidityDays: 90

# =============================================================================
# Users - Authorized Administrators
# =============================================================================
Users:
  admin:
    Certificate: "-----BEGIN CERTIFICATE-----\n<ADMIN_CERTIFICATE_HERE>\n-----END CERTIFICATE-----"
    Roles:
      - admin

  operator:
    Certificate: "-----BEGIN CERTIFICATE-----\n<OPERATOR_CERTIFICATE_HERE>\n-----END CERTIFICATE-----"
    Roles:
      - operator

# =============================================================================
# Roles - Permission Definitions
# =============================================================================
Roles:
  admin:
    ResourceType: "*"
    Actions:
      - "*"

  operator:
    ResourceType: Secrets
    ResourceNames:
      - supabase_service_key
    Actions:
      - ReadSecret
      - WriteSecret

  secret-reader:
    ResourceType: Secrets
    Actions:
      - ReadSecret

# =============================================================================
# Recovery Keys - Multi-Party Recovery
# =============================================================================
RecoveryKeys:
  recovery-key-1: |
    -----BEGIN PUBLIC KEY-----
    <RSA_PUBLIC_KEY_1_HERE>
    -----END PUBLIC KEY-----

  recovery-key-2: |
    -----BEGIN PUBLIC KEY-----
    <RSA_PUBLIC_KEY_2_HERE>
    -----END PUBLIC KEY-----

  recovery-key-3: |
    -----BEGIN PUBLIC KEY-----
    <RSA_PUBLIC_KEY_3_HERE>
    -----END PUBLIC KEY-----

# =============================================================================
# TLS - Global TLS Policies
# =============================================================================
TLS:
  Incoming:
    coordinator:
      - Port: "4433"
        Cert: coordinator-cert
        DisableClientAuth: false

  Outgoing:
    external:
      - Port: "443"
        Cert: external-cert
        DisableClientAuth: true
