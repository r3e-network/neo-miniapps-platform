# NEO Indexer & Snapshot API

The service layer now exposes read-only endpoints for Neo chain data that has
been normalised into Postgres by `cmd/neo-indexer`, plus manifests generated by
`cmd/neo-snapshot`. These are meant for operators and the dashboard to verify
node health, fetch block/transaction data, and download stateless state
bundles.

## Endpoints (auth required)
- `GET /neo/status` — latest indexed height/hash/state root, block/tx counts,
  snapshot count, and last indexed timestamp.
- `GET /neo/blocks?limit=20&offset=0` — paginated block list (hash, state root,
  prev/next hash, size, timestamp, tx count).
- `GET /neo/blocks/{height}` — full block detail with transactions,
  per-execution VM state/exception/gas/stack, and notifications (exec index is
  preserved).
- `GET /neo/checkpoint` — convenience alias of `/neo/status` for operators to
  query latest indexed height/hash/node lag. `stable_height/hash/state_root`
  are derived as `latest_height - max(node_lag, NEO_STABLE_BUFFER)` (hash/root
  pulled from `neo_blocks` for that height). Increase `NEO_STABLE_BUFFER`
  (default 12) to be more conservative; when finality detection is added these
  fields will reflect the last stable block.
- `GET /neo/storage/{height}` — storage KV blobs captured for contracts touched
  in that block (JSON key/value entries per contract).
- `GET /neo/storage-diff/{height}` — storage KV diffs for contracts touched in
  that block (only keys whose values changed vs. previous height).
- `GET /neo/storage-summary/{height}` — per-contract counts of KV and diff
  entries for the block without streaming full blobs.
- `GET /neo/snapshots` — list manifests discovered in `NEO_SNAPSHOT_DIR`
  (defaults to `./snapshots` on the server).
- `GET /neo/snapshots/{height}` — return a single manifest (includes state
  root, contracts bundled, SHA256 of the tar.gz KV bundle, and optional
  `kv_url` if provided when generating).
- `GET /neo/snapshots/{height}/kv` — stream the KV bundle tar.gz from the
  server if `kv_path` exists in the manifest (Content-Type `application/gzip`).
- `GET /neo/snapshots/{height}/kv-diff` — stream the KV diff bundle when
  present in the manifest.
- `slctl neo download --height <h> [--diff] [--out file] [--sha <sha256>]` — CLI
  helper to pull bundles from the new endpoints and optionally verify the hash.
- `slctl neo verify-all --height <h>` (or `--manifest <url|/neo/snapshots/h>` or `--heights h1,h2,...)` `[--download=false] [--out manifest.json] [--kv-out ...]` —
  one-shot manifest + bundle download and verification (hash + signature when present) across one or many heights.
- `slctl manifest --url <manifest> [--download-bundles] [--out file]` — fetch a manifest (HTTP/API-relative/local), verify hashes/signature, and optionally save manifest + bundles in one run.
- `verify-all` prints a per-target summary (OK/FAIL) and exits non-zero if any target fails verification.

All endpoints require the standard `Authorization: Bearer <token or JWT>`
header; tenants are not required because the data is global.

## Indexer

Run a local indexer pointing at a `neo-cli` node:

```bash
go run ./cmd/neo-indexer \
  -rpc http://localhost:10332 \
  -dsn "postgres://service_layer:service_layer@localhost:5432/service_layer?sslmode=disable" \
  -network mainnet \
  -batch 100 \
  -poll 2s
```

Schema:
- `neo_blocks` (height, hash, prev/next hash, state_root, size, block_time)
- `neo_transactions` (hash, height, ordinal, type, sender, net/sys fee, size,
  vm_state, exception, gas_consumed, stack, raw)
- `neo_transaction_executions` (per-execution vm_state/exception/gas/stack +
  serialized notifications)
- `neo_notifications` (contract, event, exec_index, state)
- `neo_storage` (height, contract, kv JSONB) — per-contract storage captured for
  contracts touched by that block (via notifications).
- `neo_storage_diffs` (height, contract, kv_diff JSONB) — per-contract storage
  diffs for touched contracts relative to the last stored height.
- `neo_meta` stores last processed height/hash for checkpointed resume.

Snapshot generation notes:
- `cmd/neo-snapshot` can reuse stored KV from Postgres when `-dsn` / `NEO_SNAPSHOT_DSN`
  is provided; when no contracts are specified, it will include all contracts
  found in `neo_storage` for that height. Otherwise it falls back to RPC
  `getcontractstorage` for requested contracts.
- If storage diffs exist in `neo_storage_diffs`, `neo-snapshot` also emits a KV
  diff bundle and hashes/URLs in the manifest.
- Manifests can be signed with an ed25519 key (`--signing-key` or `NEO_SNAPSHOT_SIGNING_KEY`);
  payload: `network|height|state_root|kv_sha256|kv_diff_sha256`. `slctl neo verify-manifest`
  validates the signature; the dashboard “Verify” button now checks both bundle
  hashes and the manifest signature when present.
- CLI one-liner to validate a manifest and its bundles: `slctl manifest --url http://localhost:8080/neo/snapshots/<height>`
  (downloads the manifest, verifies KV + diff bundle hashes, and checks the signature if present).
- `/neo/status` will include node RPC height/lag when `NEO_RPC_STATUS_URL` is configured on the server.

Re-orgs are detected by comparing stored block hashes per height; diverging
rows are deleted and re-written on the next tick. Application logs are
persisted with verbose stack/notification data for later replay.

Progress is checkpointed in `neo_meta` so the indexer resumes from the last
processed height after restarts.

## Stateless state snapshots

Generate stateless state for a given height (state root + contract storage
KV bundle). Requires `RpcStates`/`getcontractstorage` support on the node.

```bash
go run ./cmd/neo-snapshot \
  -rpc http://localhost:10332 \
  -height 123456 \
  -contracts 0xfffdc93764dbaddd97c48f252a53ea4643faa3fd \
  -out ./snapshots \
  -kv-url-base https://example.com/neo/snapshots
```

Outputs:
- Manifest: `block-123456.json` with `state_root`, `kv_sha256`, `kv_bytes`,
  contract list, RPC URL used, and optional `kv_url`.
- Bundle: `block-123456-kv.tar.gz` containing `contract.json` files of storage
  key/value pairs.

Expose the manifest directory to the appserver with `NEO_SNAPSHOT_DIR` (default
`./snapshots`) so `/neo/snapshots` can serve them. If you host bundles
elsewhere, set `-kv-url-base` so manifests embed a public download URL.
