version: '3.8'

services:
  # =============================================================================
  # MarbleRun Coordinator
  # =============================================================================
  coordinator:
    image: ghcr.io/edgelesssys/marblerun/coordinator:v1.7.0
    container_name: marblerun-coordinator
    ports:
      - "4433:4433"   # Client API
      - "9944:9944"   # Mesh API
    environment:
      - EDG_COORDINATOR_MESH_ADDR=coordinator:2001
      - EDG_COORDINATOR_CLIENT_ADDR=coordinator:4433
      - EDG_COORDINATOR_DNS_NAMES=localhost,coordinator
      - EDG_COORDINATOR_SEAL_DIR=/coordinator/data
      - OE_SIMULATION=${OE_SIMULATION:-1}
    volumes:
      - coordinator-data:/coordinator/data
      - ./manifests:/manifests:ro
    networks:
      - marblerun
    restart: unless-stopped

  # =============================================================================
  # Gateway Marble (API Gateway)
  # =============================================================================
  gateway:
    build:
      context: ..
      dockerfile: docker/Dockerfile.gateway
    container_name: service-gateway
    ports:
      - "8080:8080"
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=coordinator:2001
      - EDG_MARBLE_TYPE=gateway
      - EDG_MARBLE_DNS_NAMES=localhost,gateway
      - EDG_MARBLE_UUID_FILE=/marble/uuid
      - OE_SIMULATION=${OE_SIMULATION:-1}
      - PORT=8080
    volumes:
      - gateway-data:/marble
    depends_on:
      - coordinator
    networks:
      - marblerun
    restart: unless-stopped

  # =============================================================================
  # VRF Service Marble
  # =============================================================================
  neorand:
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: vrf
    container_name: service-vrf
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=coordinator:2001
      - EDG_MARBLE_TYPE=neorand
      - EDG_MARBLE_DNS_NAMES=localhost,vrf
      - SERVICE_TYPE=vrf
      - OE_SIMULATION=${OE_SIMULATION:-1}
    depends_on:
      - coordinator
    networks:
      - marblerun
    restart: unless-stopped

  # =============================================================================
  # NeoVault Service Marble
  # =============================================================================
  neovault:
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: neovault
    container_name: service-neovault
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=coordinator:2001
      - EDG_MARBLE_TYPE=neovault
      - EDG_MARBLE_DNS_NAMES=localhost,neovault
      - SERVICE_TYPE=neovault
      - OE_SIMULATION=${OE_SIMULATION:-1}
    depends_on:
      - coordinator
      - accountpool
    networks:
      - marblerun
    restart: unless-stopped

  # =============================================================================
  # NeoFeeds Service Marble
  # =============================================================================
  neofeeds:
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: neofeeds
    container_name: service-neofeeds
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=coordinator:2001
      - EDG_MARBLE_TYPE=neofeeds
      - EDG_MARBLE_DNS_NAMES=localhost,neofeeds
      - SERVICE_TYPE=neofeeds
      - OE_SIMULATION=${OE_SIMULATION:-1}
    depends_on:
      - coordinator
    networks:
      - marblerun
    restart: unless-stopped

  # =============================================================================
  # NeoFlow Service Marble
  # =============================================================================
  neoflow:
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: neoflow
    container_name: service-neoflow
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=coordinator:2001
      - EDG_MARBLE_TYPE=neoflow
      - EDG_MARBLE_DNS_NAMES=localhost,neoflow
      - SERVICE_TYPE=neoflow
      - OE_SIMULATION=${OE_SIMULATION:-1}
    depends_on:
      - coordinator
    networks:
      - marblerun
    restart: unless-stopped

  # =============================================================================
  # AccountPool Service Marble (Internal - Shared Account Management)
  # Not exposed externally, used by other services (neovault, etc.)
  # =============================================================================
  neoaccounts:
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: accountpool
    container_name: service-accountpool
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=coordinator:2001
      - EDG_MARBLE_TYPE=neoaccounts
      - EDG_MARBLE_DNS_NAMES=localhost,accountpool
      - SERVICE_TYPE=accountpool
      - OE_SIMULATION=${OE_SIMULATION:-1}
    depends_on:
      - coordinator
    networks:
      - marblerun
    restart: unless-stopped

  # =============================================================================
  # NeoCompute Service Marble (Planned)
  # =============================================================================
  neocompute:
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: neocompute
    container_name: service-neocompute
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=coordinator:2001
      - EDG_MARBLE_TYPE=neocompute
      - EDG_MARBLE_DNS_NAMES=localhost,neocompute
      - SERVICE_TYPE=neocompute
      - OE_SIMULATION=${OE_SIMULATION:-1}
    depends_on:
      - coordinator
    networks:
      - marblerun
    restart: unless-stopped

networks:
  marblerun:
    driver: bridge

volumes:
  coordinator-data:
  gateway-data:
