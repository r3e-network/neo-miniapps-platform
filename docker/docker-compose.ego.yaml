# =============================================================================
# Neo Service Layer - EGo SGX Docker Compose Configuration
# =============================================================================
# Production deployment with Intel SGX enclaves using EGo runtime
#
# Requirements:
#   - Intel SGX-enabled CPU
#   - SGX driver installed (DCAP or legacy)
#   - Docker with SGX device access
#
# Usage:
#   docker-compose -f docker-compose.ego.yaml up -d

version: '3.8'

services:
  # ===========================================================================
  # Coordinator - MarbleRun Control Plane (SGX Enclave)
  # ===========================================================================
  coordinator:
    build:
      context: ..
      dockerfile: docker/Dockerfile.ego-coordinator
    container_name: neo-coordinator-sgx
    ports:
      - "4433:4433"
    environment:
      - COORDINATOR_ADDR=:4433
      - MANIFEST_PATH=/app/manifests/production.yaml
      - SEAL_MODE=ProductKey
      - SUPABASE_URL=https://dmonstzalbldzzdbbcdj.supabase.co
      - SUPABASE_KEY=${SUPABASE_SECRET_KEY}
    volumes:
      - ../manifests:/app/manifests:ro
      - coordinator-data:/app/data
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    networks:
      - neo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:4433/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ===========================================================================
  # Marbles - Confidential Services (SGX Enclaves)
  # ===========================================================================

  oracle:
    build:
      context: ..
      dockerfile: docker/Dockerfile.ego-marble
    container_name: neo-oracle-sgx
    ports:
      - "8443:8443"
    environment:
      - MARBLE_TYPE=oracle
      - COORDINATOR_ADDR=coordinator:4433
      - SERVICE_ADDR=:8443
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      coordinator:
        condition: service_healthy
    networks:
      - neo-network
    restart: unless-stopped

  vrf:
    build:
      context: ..
      dockerfile: docker/Dockerfile.ego-marble
    container_name: neo-vrf-sgx
    ports:
      - "8444:8443"
    environment:
      - MARBLE_TYPE=vrf
      - COORDINATOR_ADDR=coordinator:4433
      - SERVICE_ADDR=:8443
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      coordinator:
        condition: service_healthy
    networks:
      - neo-network
    restart: unless-stopped

  secrets:
    build:
      context: ..
      dockerfile: docker/Dockerfile.ego-marble
    container_name: neo-secrets-sgx
    ports:
      - "8445:8443"
    environment:
      - MARBLE_TYPE=secrets
      - COORDINATOR_ADDR=coordinator:4433
      - SERVICE_ADDR=:8443
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      coordinator:
        condition: service_healthy
    networks:
      - neo-network
    restart: unless-stopped

  gasbank:
    build:
      context: ..
      dockerfile: docker/Dockerfile.ego-marble
    container_name: neo-gasbank-sgx
    ports:
      - "8446:8443"
    environment:
      - MARBLE_TYPE=gasbank
      - COORDINATOR_ADDR=coordinator:4433
      - SERVICE_ADDR=:8443
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      coordinator:
        condition: service_healthy
    networks:
      - neo-network
    restart: unless-stopped

  datafeeds:
    build:
      context: ..
      dockerfile: docker/Dockerfile.ego-marble
    container_name: neo-datafeeds-sgx
    ports:
      - "8447:8443"
    environment:
      - MARBLE_TYPE=datafeeds
      - COORDINATOR_ADDR=coordinator:4433
      - SERVICE_ADDR=:8443
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      coordinator:
        condition: service_healthy
    networks:
      - neo-network
    restart: unless-stopped

  automation:
    build:
      context: ..
      dockerfile: docker/Dockerfile.ego-marble
    container_name: neo-automation-sgx
    ports:
      - "8448:8443"
    environment:
      - MARBLE_TYPE=automation
      - COORDINATOR_ADDR=coordinator:4433
      - SERVICE_ADDR=:8443
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      coordinator:
        condition: service_healthy
    networks:
      - neo-network
    restart: unless-stopped

networks:
  neo-network:
    driver: bridge

volumes:
  coordinator-data:
