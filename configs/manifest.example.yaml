# Neo Service Layer Manifest (MarbleRun-style)
# This manifest defines the complete service mesh configuration.

# =============================================================================
# Packages - Enclave Software Definitions
# =============================================================================
# Each package defines verification parameters for an enclave binary.
# Services must match these parameters to be activated.

Packages:
  # Oracle service package
  oracle-pkg:
    SignerID: "9affcfae47b848ec2caf1c49b4b283531e1cc425f93582b36806e52a43d78d1a"
    ProductID: 1
    SecurityVersion: 1
    AcceptedTCBStatuses:
      - "UpToDate"
      - "SWHardeningNeeded"

  # VRF service package
  vrf-pkg:
    SignerID: "9affcfae47b848ec2caf1c49b4b283531e1cc425f93582b36806e52a43d78d1a"
    ProductID: 2
    SecurityVersion: 1

  # Secrets service package
  secrets-pkg:
    SignerID: "9affcfae47b848ec2caf1c49b4b283531e1cc425f93582b36806e52a43d78d1a"
    ProductID: 3
    SecurityVersion: 1

  # GasBank service package
  gasbank-pkg:
    SignerID: "9affcfae47b848ec2caf1c49b4b283531e1cc425f93582b36806e52a43d78d1a"
    ProductID: 4
    SecurityVersion: 1

  # Development package (allows any enclave in debug mode)
  dev-pkg:
    Debug: true

# =============================================================================
# Marbles - Service Instance Definitions
# =============================================================================
# Each marble defines a service instance with its configuration.

Marbles:
  # Oracle Service
  oracle:
    Package: oracle-pkg
    MaxActivations: 3
    Capabilities:
      - secrets
      - network
      - network.external
      - keys
      - database
      - contract
    ResourceLimits:
      MaxMemory: 536870912  # 512MB
      MaxCPUTime: 30s
      MaxNetworkReqs: 100
      MaxSecrets: 50
    Parameters:
      Env:
        SERVICE_ID: "oracle"
        VERSION: "1.0.0"
        DESCRIPTION: "Oracle service for external data fetching"
        LOG_LEVEL: "info"
        CACHE_TTL: "{{ .Secrets.oracle_cache_ttl }}"
      Files:
        /config/oracle.json: |
          {
            "endpoints": {{ raw .Secrets.oracle_endpoints }},
            "timeout": 30000
          }
    TLS:
      Incoming:
        - Port: "8443"
          Cert: oracle-cert
          AllowedMarbles:
            - gateway
            - automation
      Outgoing:
        - Port: "*"
          Cert: oracle-cert

  # VRF Service
  vrf:
    Package: vrf-pkg
    MaxActivations: 2
    Capabilities:
      - secrets
      - keys
      - keys.sign
      - database
      - contract
    Parameters:
      Env:
        SERVICE_ID: "vrf"
        VERSION: "1.0.0"
        CALLBACK_GAS: "200000"
    TLS:
      Incoming:
        - Port: "8443"
          Cert: vrf-cert
          AllowedMarbles:
            - gateway

  # Secrets Service
  secrets:
    Package: secrets-pkg
    MaxActivations: 2
    Capabilities:
      - secrets
      - secrets.write
      - keys
      - database
      - attestation
    Parameters:
      Env:
        SERVICE_ID: "secrets"
        VERSION: "1.0.0"
        MAX_SECRET_SIZE: "65536"
    TLS:
      Incoming:
        - Port: "8443"
          Cert: secrets-cert

  # GasBank Service
  gasbank:
    Package: gasbank-pkg
    MaxActivations: 2
    Capabilities:
      - secrets
      - keys
      - neo
      - neo.sign
      - database
      - contract
    Parameters:
      Env:
        SERVICE_ID: "gasbank"
        VERSION: "1.0.0"
    TLS:
      Incoming:
        - Port: "8443"
          Cert: gasbank-cert

# =============================================================================
# Secrets - Cryptographic Secret Definitions
# =============================================================================
# Secrets are generated by the Coordinator or provided by users.

Secrets:
  # Root CA for mesh TLS
  mesh-ca:
    Type: cert-ecdsa
    Cert:
      Subject:
        CommonName: "Neo Service Layer Mesh CA"
        Organization:
          - "Neo Service Layer"
      IsCA: true
      ValidityDays: 3650

  # Service certificates (signed by mesh-ca)
  oracle-cert:
    Type: cert-ecdsa
    Cert:
      Subject:
        CommonName: "oracle.service-layer.local"
      DNSNames:
        - "oracle"
        - "oracle.service-layer.local"
      SignedBy: mesh-ca
      ValidityDays: 365

  vrf-cert:
    Type: cert-ecdsa
    Cert:
      Subject:
        CommonName: "vrf.service-layer.local"
      DNSNames:
        - "vrf"
        - "vrf.service-layer.local"
      SignedBy: mesh-ca
      ValidityDays: 365

  secrets-cert:
    Type: cert-ecdsa
    Cert:
      Subject:
        CommonName: "secrets.service-layer.local"
      DNSNames:
        - "secrets"
        - "secrets.service-layer.local"
      SignedBy: mesh-ca
      ValidityDays: 365

  gasbank-cert:
    Type: cert-ecdsa
    Cert:
      Subject:
        CommonName: "gasbank.service-layer.local"
      DNSNames:
        - "gasbank"
        - "gasbank.service-layer.local"
      SignedBy: mesh-ca
      ValidityDays: 365

  # Symmetric key for internal encryption
  internal-key:
    Type: symmetric-key
    Size: 256
    Shared: true

  # User-defined secrets (must be provided via API)
  oracle_endpoints:
    Type: plain
    UserDefined: true

  oracle_cache_ttl:
    Type: plain
    UserDefined: true

  supabase_key:
    Type: plain
    UserDefined: true

# =============================================================================
# Users - Authorized Users with Certificate Authentication
# =============================================================================

Users:
  admin:
    Certificate: |
      -----BEGIN CERTIFICATE-----
      MIIBkTCB+wIJAKHBfpegPjMCMA0GCSqGSIb3DQEBCwUAMBExDzANBgNVBAMMBmFk
      bWluMB4XDTI0MDEwMTAwMDAwMFoXDTI1MDEwMTAwMDAwMFowETEPMA0GA1UEAwwG
      YWRtaW4wXDANBgkqhkiG9w0BAQEFAANLADBIAkEA0Z3VS5JJcds3xKFkEg5FMQNB
      ... (truncated for example)
      -----END CERTIFICATE-----
    Roles:
      - admin-role
      - recovery-role

  operator:
    Certificate: |
      -----BEGIN CERTIFICATE-----
      ... (operator certificate)
      -----END CERTIFICATE-----
    Roles:
      - operator-role

# =============================================================================
# Roles - Permission Definitions
# =============================================================================

Roles:
  admin-role:
    ResourceType: "*"
    ResourceNames: []  # Empty = all resources
    Actions:
      - "*"

  recovery-role:
    ResourceType: Recovery
    Actions:
      - Recover

  operator-role:
    ResourceType: Secrets
    ResourceNames:
      - oracle_endpoints
      - oracle_cache_ttl
      - supabase_key
    Actions:
      - ReadSecret
      - WriteSecret

  viewer-role:
    ResourceType: Status
    Actions:
      - Read

# =============================================================================
# Recovery Keys - Multi-Party Recovery
# =============================================================================
# RSA public keys for recovery. The Coordinator encrypts its sealing key
# with each recovery key. Recovery requires a threshold of key holders.

RecoveryKeys:
  admin:
    -----BEGIN PUBLIC KEY-----
    MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...
    -----END PUBLIC KEY-----

# =============================================================================
# TLS - Global TLS Policies
# =============================================================================

TLS:
  Incoming:
    gateway:
      - Port: "443"
        Cert: gateway-cert
        DisableClientAuth: true  # Public API
  Outgoing:
    "*":
      - Port: "*"
        Cert: mesh-ca

# =============================================================================
# Config - Service Configuration
# =============================================================================

Config:
  neo_rpc_endpoint:
    Value: "http://seed1.neo.org:10332"
  neo_network:
    Value: "mainnet"
  supabase_url:
    Value: "https://your-project.supabase.co"
    Secret: false
